# ============================================================
# UNS VISA MANAGEMENT SYSTEM
# Docker Compose Configuration
# 
# ⚠️  PUERTOS PERSONALIZADOS (evitar conflictos con otras apps)
# ============================================================

version: '3.8'

services:
  # ============================================================
  # PostgreSQL Database
  # Puerto: 5433 (en lugar de 5432)
  # ============================================================
  db:
    image: postgres:15-alpine
    container_name: uns-visa-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: uns_visa
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-unsvisapassword2024}
    volumes:
      - uns_postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/01-init.sql
    ports:
      - "5433:5432"  # ⚠️ Puerto externo 5433
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - uns-visa-network

  # ============================================================
  # Backend API (FastAPI)
  # Puerto: 8100 (en lugar de 8000)
  # ============================================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: uns-visa-api
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD:-unsvisapassword2024}@db:5432/uns_visa
      SECRET_KEY: ${SECRET_KEY:-your-secret-key-change-in-production}
      DEBUG: ${DEBUG:-false}
      API_PORT: 8100
    ports:
      - "8100:8000"  # ⚠️ Puerto externo 8100
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - ./uploads:/app/uploads
      - ./generated:/app/generated
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - uns-visa-network

  # ============================================================
  # Frontend (Nginx serving static files)
  # Puerto: 8180 HTTP, 8143 HTTPS (en lugar de 80/443)
  # ============================================================
  frontend:
    image: nginx:alpine
    container_name: uns-visa-frontend
    restart: unless-stopped
    ports:
      - "8180:80"    # ⚠️ Puerto HTTP 8180
      - "8143:443"   # ⚠️ Puerto HTTPS 8143
    volumes:
      - ./frontend:/usr/share/nginx/html
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - api
    networks:
      - uns-visa-network

  # ============================================================
  # Redis (para caché y sesiones)
  # Puerto: 6380 (en lugar de 6379)
  # ============================================================
  redis:
    image: redis:7-alpine
    container_name: uns-visa-redis
    restart: unless-stopped
    ports:
      - "6380:6379"  # ⚠️ Puerto externo 6380
    volumes:
      - uns_redis_data:/data
    networks:
      - uns-visa-network

  # ============================================================
  # Adminer (Database management UI)
  # Puerto: 8181 (en lugar de 8080)
  # ============================================================
  adminer:
    image: adminer:latest
    container_name: uns-visa-adminer
    restart: unless-stopped
    ports:
      - "8181:8080"  # ⚠️ Puerto externo 8181
    depends_on:
      - db
    environment:
      ADMINER_DEFAULT_SERVER: db
    networks:
      - uns-visa-network

volumes:
  uns_postgres_data:
    name: uns-visa-postgres-data
  uns_redis_data:
    name: uns-visa-redis-data

networks:
  uns-visa-network:
    name: uns-visa-network
    driver: bridge
