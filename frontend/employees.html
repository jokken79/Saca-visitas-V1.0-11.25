<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾“æ¥­å“¡ç®¡ç† - UNS Visa Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="ui-shell.js" defer></script>
    <script src="validators.js"></script>
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .status-ok { background: #10b981; }
        .status-soon { background: #3b82f6; }
        .status-warning { background: #f59e0b; }
        .status-critical { background: #ef4444; }
        .status-expired { background: #7f1d1d; }
    </style>
</head>
<body class="app-body">
    <main class="page-container">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">å¾“æ¥­å“¡ä¸€è¦§</h1>
                <p class="text-slate-500">Employee Management</p>
            </div>
            <button onclick="openModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors">
                <i data-lucide="user-plus" class="w-4 h-4"></i>
                <span>æ–°è¦ç™»éŒ²</span>
            </button>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm text-slate-600 mb-1">æ¤œç´¢</label>
                    <input type="text" id="search" placeholder="åå‰ã€åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå·..." 
                           class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           oninput="filterEmployees()">
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1">å›½ç±</label>
                    <select id="filter-nationality" class="w-full border rounded-lg px-3 py-2" onchange="filterEmployees()">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="ãƒ™ãƒˆãƒŠãƒ ">ãƒ™ãƒˆãƒŠãƒ </option>
                        <option value="ä¸­å›½">ä¸­å›½</option>
                        <option value="ãƒ•ã‚£ãƒªãƒ”ãƒ³">ãƒ•ã‚£ãƒªãƒ”ãƒ³</option>
                        <option value="ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢</option>
                        <option value="ãƒãƒ‘ãƒ¼ãƒ«">ãƒãƒ‘ãƒ¼ãƒ«</option>
                        <option value="ãƒ–ãƒ©ã‚¸ãƒ«">ãƒ–ãƒ©ã‚¸ãƒ«</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1">åœ¨ç•™æœŸé™</label>
                    <select id="filter-visa" class="w-full border rounded-lg px-3 py-2" onchange="filterEmployees()">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="30">30æ—¥ä»¥å†…</option>
                        <option value="60">60æ—¥ä»¥å†…</option>
                        <option value="90">90æ—¥ä»¥å†…</option>
                        <option value="expired">æœŸé™åˆ‡ã‚Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1">çŠ¶æ…‹</label>
                    <select id="filter-status" class="w-full border rounded-lg px-3 py-2" onchange="filterEmployees()">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="active">åœ¨ç±ä¸­</option>
                        <option value="inactive">é€€è·</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="exportCSV()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-4">
                <div class="text-3xl font-bold text-slate-800" id="stat-total">0</div>
                <div class="text-sm text-slate-500">ç·å¾“æ¥­å“¡æ•°</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-yellow-500">
                <div class="text-3xl font-bold text-yellow-600" id="stat-warning">0</div>
                <div class="text-sm text-slate-500">90æ—¥ä»¥å†…æœŸé™</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-500">
                <div class="text-3xl font-bold text-red-600" id="stat-critical">0</div>
                <div class="text-sm text-slate-500">30æ—¥ä»¥å†…æœŸé™</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-500">
                <div class="text-3xl font-bold text-green-600" id="stat-ok">0</div>
                <div class="text-sm text-slate-500">å•é¡Œãªã—</div>
            </div>
        </div>

        <!-- Employee Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
                <thead class="bg-slate-50 border-b">
                    <tr>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">å¾“æ¥­å“¡</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">å›½ç±</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">åœ¨ç•™è³‡æ ¼</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">åœ¨ç•™æœŸé™</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">çŠ¶æ…‹</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">åœ¨ç•™ã‚«ãƒ¼ãƒ‰</th>
                        <th class="text-center px-4 py-3 text-sm font-medium text-slate-600">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="employee-table" class="divide-y">
                    <!-- Employees will be loaded here -->
                </tbody>
            </table>

            <!-- Empty State -->
            <div id="empty-state" class="hidden py-12 text-center">
                <div class="text-6xl mb-4">ğŸ‘¥</div>
                <p class="text-slate-500">å¾“æ¥­å“¡ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                <button onclick="openModal('add')" class="mt-4 text-blue-600 hover:text-blue-700">
                    + æ–°è¦ç™»éŒ²ã™ã‚‹
                </button>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="py-12 text-center">
                <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-slate-500">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center mt-4">
            <div class="text-sm text-slate-500" id="pagination-info">
                0 ä»¶ä¸­ 0 - 0 ä»¶ã‚’è¡¨ç¤º
            </div>
            <div class="flex gap-2">
                <button id="prev-page" onclick="prevPage()" disabled 
                        class="px-4 py-2 border rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">
                    å‰ã¸
                </button>
                <button id="next-page" onclick="nextPage()" disabled
                        class="px-4 py-2 border rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">
                    æ¬¡ã¸
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="employee-modal" class="fixed inset-0 bg-black/50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen flex items-start justify-center p-4 pt-10">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl">
                <!-- Modal Header -->
                <div class="flex justify-between items-center px-6 py-4 border-b">
                    <h2 id="modal-title" class="text-xl font-bold">å¾“æ¥­å“¡ç™»éŒ²</h2>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>

                <!-- Modal Body -->
                <form id="employee-form" class="p-6 space-y-6">
                    <input type="hidden" id="employee-id">

                    <!-- Basic Info -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-slate-700 mb-4">ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">å§“ (ãƒ­ãƒ¼ãƒå­—) <span class="text-red-500">*</span></label>
                                <input type="text" id="family-name" required
                                       class="w-full border rounded-lg px-3 py-2 uppercase" placeholder="NGUYEN">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">å (ãƒ­ãƒ¼ãƒå­—) <span class="text-red-500">*</span></label>
                                <input type="text" id="given-name" required
                                       class="w-full border rounded-lg px-3 py-2 uppercase" placeholder="VAN MINH">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">æ¼¢å­—æ°å</label>
                                <input type="text" id="name-kanji"
                                       class="w-full border rounded-lg px-3 py-2" placeholder="ã‚°ã‚¨ãƒ³ã€€ãƒ´ã‚¡ãƒ³ã€€ãƒŸãƒ³">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">å›½ç± <span class="text-red-500">*</span></label>
                                <select id="nationality" required class="w-full border rounded-lg px-3 py-2">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="ãƒ™ãƒˆãƒŠãƒ ">ãƒ™ãƒˆãƒŠãƒ </option>
                                    <option value="ä¸­å›½">ä¸­å›½</option>
                                    <option value="ãƒ•ã‚£ãƒªãƒ”ãƒ³">ãƒ•ã‚£ãƒªãƒ”ãƒ³</option>
                                    <option value="ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢">ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢</option>
                                    <option value="ãƒãƒ‘ãƒ¼ãƒ«">ãƒãƒ‘ãƒ¼ãƒ«</option>
                                    <option value="ãƒ–ãƒ©ã‚¸ãƒ«">ãƒ–ãƒ©ã‚¸ãƒ«</option>
                                    <option value="éŸ“å›½">éŸ“å›½</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">ç”Ÿå¹´æœˆæ—¥ <span class="text-red-500">*</span></label>
                                <input type="date" id="date-of-birth" required
                                       class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">æ€§åˆ¥ <span class="text-red-500">*</span></label>
                                <select id="sex" required class="w-full border rounded-lg px-3 py-2">
                                    <option value="">é¸æŠ</option>
                                    <option value="male">ç”·æ€§</option>
                                    <option value="female">å¥³æ€§</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Passport Info -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-slate-700 mb-4">ğŸ›‚ ãƒ‘ã‚¹ãƒãƒ¼ãƒˆæƒ…å ±</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">æ—…åˆ¸ç•ªå· <span class="text-red-500">*</span></label>
                                <input type="text" id="passport-number" required
                                       class="w-full border rounded-lg px-3 py-2 uppercase" placeholder="B12345678">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">æœ‰åŠ¹æœŸé™ <span class="text-red-500">*</span></label>
                                <input type="date" id="passport-expiration" required
                                       class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">ç™ºè¡Œå›½</label>
                                <input type="text" id="passport-issue-country"
                                       class="w-full border rounded-lg px-3 py-2" placeholder="VIETNAM">
                            </div>
                        </div>
                    </div>

                    <!-- Visa Info -->
                    <div class="border rounded-lg p-4 bg-blue-50">
                        <h3 class="font-bold text-slate-700 mb-4">ğŸ“„ åœ¨ç•™è³‡æ ¼æƒ…å ±</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">åœ¨ç•™è³‡æ ¼</label>
                                <select id="visa-status" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="æŠ€è¡“ãƒ»äººæ–‡çŸ¥è­˜ãƒ»å›½éš›æ¥­å‹™">æŠ€è¡“ãƒ»äººæ–‡çŸ¥è­˜ãƒ»å›½éš›æ¥­å‹™</option>
                                    <option value="ç‰¹å®šæŠ€èƒ½1å·">ç‰¹å®šæŠ€èƒ½1å·</option>
                                    <option value="ç‰¹å®šæŠ€èƒ½2å·">ç‰¹å®šæŠ€èƒ½2å·</option>
                                    <option value="æŠ€èƒ½å®Ÿç¿’1å·">æŠ€èƒ½å®Ÿç¿’1å·</option>
                                    <option value="æŠ€èƒ½å®Ÿç¿’2å·">æŠ€èƒ½å®Ÿç¿’2å·</option>
                                    <option value="æŠ€èƒ½å®Ÿç¿’3å·">æŠ€èƒ½å®Ÿç¿’3å·</option>
                                    <option value="æ°¸ä½è€…">æ°¸ä½è€…</option>
                                    <option value="å®šä½è€…">å®šä½è€…</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">åœ¨ç•™æœŸé–“</label>
                                <select id="period-of-stay" class="w-full border rounded-lg px-3 py-2">
                                    <option value="">é¸æŠ</option>
                                    <option value="5å¹´">5å¹´</option>
                                    <option value="3å¹´">3å¹´</option>
                                    <option value="1å¹´">1å¹´</option>
                                    <option value="6æœˆ">6æœˆ</option>
                                    <option value="3æœˆ">3æœˆ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">åœ¨ç•™æœŸé™ <span class="text-red-500">*</span></label>
                                <input type="date" id="expiration-date" required
                                       class="w-full border rounded-lg px-3 py-2">
                                <p id="expiration-warning" class="text-sm mt-1 hidden"></p>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-slate-600 mb-1">åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå·</label>
                                <input type="text" id="residence-card"
                                       class="w-full border rounded-lg px-3 py-2 uppercase font-mono" 
                                       placeholder="AB12345678CD"
                                       maxlength="12">
                                <p id="card-error" class="text-red-500 text-sm mt-1 hidden"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-slate-700 mb-4">ğŸ“ é€£çµ¡å…ˆ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">éƒµä¾¿ç•ªå·</label>
                                <input type="text" id="postal-code"
                                       class="w-full border rounded-lg px-3 py-2" placeholder="123-4567">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">ä½æ‰€</label>
                                <input type="text" id="address"
                                       class="w-full border rounded-lg px-3 py-2" placeholder="æ„›çŸ¥çœŒåå¤å±‹å¸‚...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">é›»è©±ç•ªå·</label>
                                <input type="tel" id="telephone"
                                       class="w-full border rounded-lg px-3 py-2" placeholder="052-123-4567">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">æºå¸¯é›»è©±</label>
                                <input type="tel" id="cellular"
                                       class="w-full border rounded-lg px-3 py-2" placeholder="090-1234-5678">
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Modal Footer -->
                <div class="flex justify-end gap-3 px-6 py-4 border-t bg-slate-50 rounded-b-2xl">
                    <button onclick="closeModal()" class="px-6 py-2 border rounded-lg hover:bg-slate-100 transition-colors">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button onclick="saveEmployee()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>
    </main>

    <script>
        // API Base
        const API_BASE = '/api';
        
        // State
        let employees = [];
        let filteredEmployees = [];
        let currentPage = 1;
        const pageSize = 20;

        // Check auth
        function checkAuth() {
            const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login.html';
                return null;
            }
            return token;
        }

        function logout() {
            localStorage.removeItem('access_token');
            sessionStorage.removeItem('access_token');
            window.location.href = '/login.html';
        }

        // Load employees
        async function loadEmployees() {
            const token = checkAuth();
            if (!token) return;

            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('employee-table').innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/employees`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                employees = await response.json();
                filteredEmployees = [...employees];
                updateStats();
                renderEmployees();

            } catch (error) {
                console.error('Error loading employees:', error);
            } finally {
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        // Update stats
        function updateStats() {
            const total = filteredEmployees.length;
            let warning = 0, critical = 0, ok = 0;

            filteredEmployees.forEach(emp => {
                if (emp.visa_status) {
                    if (emp.visa_status.status === 'critical' || emp.visa_status.status === 'expired') {
                        critical++;
                    } else if (emp.visa_status.status === 'warning' || emp.visa_status.status === 'soon') {
                        warning++;
                    } else {
                        ok++;
                    }
                }
            });

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-warning').textContent = warning;
            document.getElementById('stat-critical').textContent = critical;
            document.getElementById('stat-ok').textContent = ok;
        }

        // Render employees
        function renderEmployees() {
            const tbody = document.getElementById('employee-table');
            const emptyState = document.getElementById('empty-state');

            if (filteredEmployees.length === 0) {
                emptyState.classList.remove('hidden');
                tbody.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageEmployees = filteredEmployees.slice(start, end);

            tbody.innerHTML = pageEmployees.map(emp => {
                const visaStatus = emp.visa_status || {};
                const statusClass = `status-${visaStatus.status || 'ok'}`;
                const daysText = visaStatus.message || 'æƒ…å ±ãªã—';

                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3">
                            <div class="font-medium text-slate-800">${emp.family_name} ${emp.given_name}</div>
                            <div class="text-sm text-slate-500">${emp.employee_code || ''}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center gap-1">
                                ${getNationalityFlag(emp.nationality)}
                                ${emp.nationality || '-'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">${emp.current_visa_status || '-'}</td>
                        <td class="px-4 py-3">
                            <div class="text-sm">${formatDate(emp.current_expiration_date)}</div>
                            <div class="text-xs ${statusClass === 'status-ok' ? 'text-green-600' : 'text-red-600'}">${daysText}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-block w-3 h-3 rounded-full ${statusClass}"></span>
                        </td>
                        <td class="px-4 py-3 font-mono text-sm">${emp.residence_card_number || '-'}</td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="openModal('edit', ${emp.id})" class="text-blue-600 hover:text-blue-800" title="ç·¨é›†">âœï¸</button>
                                <button onclick="generateForm(${emp.id})" class="text-green-600 hover:text-green-800" title="æ›´æ–°ç”³è«‹æ›¸">ğŸ“„ æ›´æ–°</button>
                                <button onclick="generateCoeForm(${emp.id})" class="text-purple-600 hover:text-purple-800" title="èªå®šç”³è«‹æ›¸">ğŸ“„ COE</button>
                                <button onclick="deleteEmployee(${emp.id})" class="text-red-600 hover:text-red-800" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update pagination
            const totalPages = Math.ceil(filteredEmployees.length / pageSize);
            document.getElementById('pagination-info').textContent = 
                `${filteredEmployees.length} ä»¶ä¸­ ${start + 1} - ${Math.min(end, filteredEmployees.length)} ä»¶ã‚’è¡¨ç¤º`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function getNationalityFlag(nationality) {
            const flags = {
                'ãƒ™ãƒˆãƒŠãƒ ': 'ğŸ‡»ğŸ‡³',
                'ä¸­å›½': 'ğŸ‡¨ğŸ‡³',
                'ãƒ•ã‚£ãƒªãƒ”ãƒ³': 'ğŸ‡µğŸ‡­',
                'ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢': 'ğŸ‡®ğŸ‡©',
                'ãƒãƒ‘ãƒ¼ãƒ«': 'ğŸ‡³ğŸ‡µ',
                'ãƒ–ãƒ©ã‚¸ãƒ«': 'ğŸ‡§ğŸ‡·',
                'éŸ“å›½': 'ğŸ‡°ğŸ‡·'
            };
            return flags[nationality] || 'ğŸŒ';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ja-JP');
        }

        // Filter
        function filterEmployees() {
            const search = document.getElementById('search').value.toLowerCase();
            const nationality = document.getElementById('filter-nationality').value;
            const visaFilter = document.getElementById('filter-visa').value;
            const status = document.getElementById('filter-status').value;

            filteredEmployees = employees.filter(emp => {
                // Search
                const matchSearch = !search || 
                    (emp.family_name + ' ' + emp.given_name).toLowerCase().includes(search) ||
                    (emp.residence_card_number || '').toLowerCase().includes(search) ||
                    (emp.employee_code || '').toLowerCase().includes(search);

                // Nationality
                const matchNationality = !nationality || emp.nationality === nationality;

                // Visa expiration
                let matchVisa = true;
                if (visaFilter && emp.visa_status) {
                    const days = emp.visa_status.days_remaining;
                    if (visaFilter === 'expired') {
                        matchVisa = days < 0;
                    } else {
                        matchVisa = days <= parseInt(visaFilter) && days >= 0;
                    }
                }

                // Status
                const matchStatus = !status || emp.employment_status === status;

                return matchSearch && matchNationality && matchVisa && matchStatus;
            });

            currentPage = 1;
            updateStats();
            renderEmployees();
        }

        // Pagination
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderEmployees();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredEmployees.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderEmployees();
            }
        }

        // Modal
        function openModal(mode, employeeId = null) {
            const modal = document.getElementById('employee-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('employee-form');

            form.reset();
            document.getElementById('employee-id').value = '';

            if (mode === 'edit' && employeeId) {
                title.textContent = 'å¾“æ¥­å“¡ç·¨é›†';
                const emp = employees.find(e => e.id === employeeId);
                if (emp) {
                    fillForm(emp);
                }
            } else {
                title.textContent = 'å¾“æ¥­å“¡ç™»éŒ²';
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('employee-modal').classList.add('hidden');
        }

        function fillForm(emp) {
            document.getElementById('employee-id').value = emp.id;
            document.getElementById('family-name').value = emp.family_name || '';
            document.getElementById('given-name').value = emp.given_name || '';
            document.getElementById('name-kanji').value = (emp.family_name_kanji || '') + ' ' + (emp.given_name_kanji || '');
            document.getElementById('nationality').value = emp.nationality || '';
            document.getElementById('date-of-birth').value = emp.date_of_birth || '';
            document.getElementById('sex').value = emp.sex || '';
            document.getElementById('passport-number').value = emp.passport_number || '';
            document.getElementById('passport-expiration').value = emp.passport_expiration || '';
            document.getElementById('passport-issue-country').value = emp.passport_issue_country || '';
            document.getElementById('visa-status').value = emp.current_visa_status || '';
            document.getElementById('period-of-stay').value = emp.current_period_of_stay || '';
            document.getElementById('expiration-date').value = emp.current_expiration_date || '';
            document.getElementById('residence-card').value = emp.residence_card_number || '';
            document.getElementById('postal-code').value = emp.postal_code_japan || '';
            document.getElementById('address').value = emp.address_japan || '';
            document.getElementById('telephone').value = emp.telephone_japan || '';
            document.getElementById('cellular').value = emp.cellular_phone || '';
        }

        async function saveEmployee() {
            const token = checkAuth();
            if (!token) return;

            const employeeId = document.getElementById('employee-id').value;
            const data = {
                family_name: document.getElementById('family-name').value.toUpperCase(),
                given_name: document.getElementById('given-name').value.toUpperCase(),
                nationality: document.getElementById('nationality').value,
                date_of_birth: document.getElementById('date-of-birth').value,
                sex: document.getElementById('sex').value,
                passport_number: document.getElementById('passport-number').value.toUpperCase(),
                passport_expiration: document.getElementById('passport-expiration').value,
                passport_issue_country: document.getElementById('passport-issue-country').value,
                current_visa_status: document.getElementById('visa-status').value,
                current_period_of_stay: document.getElementById('period-of-stay').value,
                current_expiration_date: document.getElementById('expiration-date').value,
                residence_card_number: document.getElementById('residence-card').value.toUpperCase(),
                postal_code_japan: document.getElementById('postal-code').value,
                address_japan: document.getElementById('address').value,
                telephone_japan: document.getElementById('telephone').value,
                cellular_phone: document.getElementById('cellular').value
            };

            // Validate residence card
            if (data.residence_card_number && typeof VisaValidators !== 'undefined') {
                const cardResult = VisaValidators.residenceCard.validate(data.residence_card_number);
                if (!cardResult.valid) {
                    document.getElementById('card-error').textContent = cardResult.error;
                    document.getElementById('card-error').classList.remove('hidden');
                    return;
                }
            }

            try {
                const url = employeeId ? `${API_BASE}/employees/${employeeId}` : `${API_BASE}/employees`;
                const method = employeeId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    loadEmployees();
                    alert(employeeId ? 'æ›´æ–°ã—ã¾ã—ãŸ' : 'ç™»éŒ²ã—ã¾ã—ãŸ');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error saving employee:', error);
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function deleteEmployee(id) {
            if (!confirm('ã“ã®å¾“æ¥­å“¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE}/employees/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    loadEmployees();
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error deleting employee:', error);
            }
        }

        async function generateForm(id) {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE}/export/visa-renewal/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `visa_renewal_${id}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const error = await response.json();
                    alert(error.detail || 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error exporting form:', error);
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function generateCoeForm(id) {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE}/export/visa-coe/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `visa_coe_${id}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const error = await response.json();
                    alert(error.detail || 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error exporting COE form:', error);
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        function exportCSV() {
            const headers = ['ç¤¾å“¡ç•ªå·', 'å§“', 'å', 'å›½ç±', 'åœ¨ç•™è³‡æ ¼', 'åœ¨ç•™æœŸé™', 'åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå·', 'æºå¸¯é›»è©±'];
            const rows = filteredEmployees.map(emp => [
                emp.employee_code || '',
                emp.family_name || '',
                emp.given_name || '',
                emp.nationality || '',
                emp.current_visa_status || '',
                emp.current_expiration_date || '',
                emp.residence_card_number || '',
                emp.cellular_phone || ''
            ]);

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `employees_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Validation on input
        document.getElementById('residence-card').addEventListener('input', function(e) {
            const error = document.getElementById('card-error');
            if (this.value.length === 12 && typeof VisaValidators !== 'undefined') {
                const result = VisaValidators.residenceCard.validate(this.value);
                if (!result.valid) {
                    error.textContent = result.error;
                    error.classList.remove('hidden');
                } else {
                    error.classList.add('hidden');
                }
            } else {
                error.classList.add('hidden');
            }
        });

        document.getElementById('expiration-date').addEventListener('change', function(e) {
            const warning = document.getElementById('expiration-warning');
            if (this.value && typeof VisaValidators !== 'undefined') {
                const result = VisaValidators.visaExpiration.validate(this.value);
                warning.textContent = result.message;
                warning.className = `text-sm mt-1 ${result.urgency === 'error' ? 'text-red-500' : result.urgency === 'warning' ? 'text-yellow-600' : 'text-green-600'}`;
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            renderAppShell({ active: 'employees', headline: 'å¾“æ¥­å“¡ç®¡ç†', subtitle: 'ãƒ“ã‚¶æœŸé™ãƒ»åœ¨ç•™ã‚«ãƒ¼ãƒ‰ã‚’ä¸€å…ƒç®¡ç†' });
            loadEmployees();
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
            renderFooter();
        });
    </script>
</body>
</html>
