<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾é£å…ˆç·¨é›† - UNS Visa Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="ui-shell.js" defer></script>
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
    </style>
</head>
<body class="app-body">
    <main class="page-container">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">æ´¾é£å…ˆã®æƒ…å ±è£œå®Œ</h1>
                <p class="text-slate-500">Haken Saki Editor - Completa datos faltantes de clientes/fÃ¡bricas</p>
            </div>
            <div class="flex gap-3">
                <button id="reload-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300" onclick="loadCompanies()">å†èª­ã¿è¾¼ã¿</button>
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2" onclick="openModal()">ï¼‹ æ–°è¦ç™»éŒ²</button>
            </div>
        </div>

        <!-- Filters & stats -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-4 flex items-center gap-4">
                <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xl"><i data-lucide="factory"></i></div>
                <div>
                    <div class="text-sm text-slate-500">æ´¾é£å…ˆç·æ•°</div>
                    <div id="stat-total" class="text-2xl font-bold text-slate-800">0</div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 flex items-center gap-4">
                <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center text-xl"><i data-lucide="map-pin"></i></div>
                <div>
                    <div class="text-sm text-slate-500">æƒ…å ±ä¸è¶³ã®æ´¾é£å…ˆ</div>
                    <div id="stat-missing" class="text-2xl font-bold text-amber-600">0</div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-xl"><i data-lucide="shield-check"></i></div>
                <div>
                    <div class="text-sm text-slate-500">æƒ…å ±å®Œå‚™</div>
                    <div id="stat-complete" class="text-2xl font-bold text-emerald-700">0</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm text-slate-600 mb-1">æ¤œç´¢</label>
                    <input id="search" type="text" placeholder="ä¼šç¤¾åã€ä½æ‰€ã€æ‹…å½“è€…..." class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400" oninput="renderTable()">
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1">è¡¨ç¤º</label>
                    <select id="filter-missing" class="w-full border rounded-lg px-3 py-2" onchange="renderTable()">
                        <option value="all">ã™ã¹ã¦</option>
                        <option value="missing">æƒ…å ±ä¸è¶³ã®ã¿</option>
                        <option value="complete">æƒ…å ±å®Œå‚™ã®ã¿</option>
                    </select>
                </div>
                <div class="flex items-end justify-end gap-2">
                    <button class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50" onclick="toggleActiveFilter()" id="active-toggle">æœ‰åŠ¹ã®ã¿</button>
                </div>
            </div>
        </div>

        <!-- Drag & drop JSON import -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Importar fÃ¡bricas desde JSON</h3>
                    <p class="text-sm text-slate-500">Arrastra `factories_index.json` y los archivos de `D:\\JPUNS-Claude.6.5.0\\BASEDATEJP\\config\\factories\\*.json`.</p>
                </div>
                <div class="flex gap-2">
                    <button id="json-file-btn" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-sm">Elegir archivos</button>
                    <button id="json-help-btn" class="px-3 py-2 bg-slate-800 text-white rounded-lg text-sm" onclick="alert('1) Arrastra factories_index.json y los JSON de factories/*.json\\n2) Se envÃ­an a /api/haken-saki de inmediato; duplicados se omiten automÃ¡ticamente'); return false;">Â¿CÃ³mo funciona?</button>
                </div>
            </div>
            <div id="json-dropzone" class="border-2 border-dashed border-slate-300 rounded-xl p-6 bg-slate-50 text-center text-slate-600 transition hover:border-orange-400 hover:bg-orange-50">
                <p class="font-semibold mb-1">Suelta aquÃ­ los .json</p>
                <p class="text-sm text-slate-500">Ruta local: D:\\JPUNS-Claude.6.5.0\\BASEDATEJP\\config\\factories_index.json y carpeta factories\\*</p>
                <p class="text-xs text-slate-400 mt-1">Se ignoran registros duplicados (mismoæ³•äººç•ªå· o mismo nombre+prefectura).</p>
            </div>
            <div id="json-import-log" class="text-xs text-slate-600 mt-2"></div>
            <input id="json-file-input" type="file" accept=".json" multiple class="hidden">
        </div>

<!-- Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
                <thead class="bg-slate-50 border-b">
                    <tr>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">ä¼šç¤¾</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">é€£çµ¡å…ˆ</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">æ‰€åœ¨åœ°</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">å¥‘ç´„</th>
                        <th class="text-left px-4 py-3 text-sm font-medium text-slate-600">çŠ¶æ…‹</th>
                        <th class="text-center px-4 py-3 text-sm font-medium text-slate-600">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y">
                    <tr id="loading-row">
                        <td colspan="6" class="text-center py-8 text-slate-500">èª­ã¿è¾¼ã¿ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="company-modal" class="fixed inset-0 bg-black/50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen flex items-start justify-center p-4 pt-10">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl">
                <div class="flex justify-between items-center px-6 py-4 border-b">
                    <div>
                        <h2 id="modal-title" class="text-xl font-bold">æ´¾é£å…ˆç™»éŒ²</h2>
                        <p class="text-sm text-slate-500">æ³•äººç•ªå·ãƒ»é›‡ç”¨ä¿é™ºãƒ»ä½æ‰€ãƒ»æ‹…å½“è€…ãªã©ä¸è¶³ã‚’è£œå®Œã—ã¦ãã ã•ã„</p>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>

                <form id="company-form" class="p-6 space-y-6" onsubmit="event.preventDefault(); saveCompany();">
                    <input type="hidden" id="company-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="border rounded-lg p-4">
                            <h3 class="font-bold text-slate-700 mb-3">ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">ä¼šç¤¾å <span class="text-red-500">*</span></label>
                                    <input required id="company-name" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡">
                                </div>
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">æ”¯åº—å</label>
                                    <input id="branch-name" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="æ±äº¬æ”¯åº—">
                                </div>
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">æ³•äººç•ªå·</label>
                                    <input id="corporation-number" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="13æ¡">
                                </div>
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">é›‡ç”¨ä¿é™ºç•ªå·</label>
                                    <input id="insurance-number" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="11æ¡">
                                </div>
                            </div>
                        </div>

                        <div class="border rounded-lg p-4">
                            <h3 class="font-bold text-slate-700 mb-3">ğŸ“ é€£çµ¡å…ˆ</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">é›»è©±ç•ªå·</label>
                                    <input id="telephone" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="052-123-4567">
                                </div>
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">FAX</label>
                                    <input id="fax" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="052-123-4568">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">æ‹…å½“è€…</label>
                                        <input id="contact-person" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="å±±ç”°å¤ªéƒ">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">ãƒ¡ãƒ¼ãƒ«</label>
                                        <input id="contact-email" type="email" class="w-full border rounded-lg px-3 py-2" placeholder="taro@example.jp">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">å‚™è€ƒ</label>
                                    <textarea id="notes" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="border rounded-lg p-4">
                            <h3 class="font-bold text-slate-700 mb-3">ğŸ“ ä½æ‰€</h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">éƒµä¾¿ç•ªå·</label>
                                        <input id="postal-code" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="100-0001">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">éƒ½é“åºœçœŒ</label>
                                        <input id="prefecture" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="æ±äº¬éƒ½">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">å¸‚åŒºç”ºæ‘</label>
                                        <input id="city" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="åƒä»£ç”°åŒº">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">ä½æ‰€ï¼‘</label>
                                    <input id="address1" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ä¸¸ã®å†…1-1-1">
                                </div>
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">ä½æ‰€ï¼’</label>
                                    <input id="address2" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="ABCãƒ“ãƒ«5F">
                                </div>
                            </div>
                        </div>

                        <div class="border rounded-lg p-4">
                            <h3 class="font-bold text-slate-700 mb-3">ğŸ“‘ å¥‘ç´„ãƒ»äº‹æ¥­</h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">å¥‘ç´„é–‹å§‹</label>
                                        <input id="contract-start" type="date" class="w-full border rounded-lg px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">å¥‘ç´„çµ‚äº†</label>
                                        <input id="contract-end" type="date" class="w-full border rounded-lg px-3 py-2">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-slate-600 mb-1">å¥‘ç´„çŠ¶æ…‹</label>
                                    <select id="contract-status" class="w-full border rounded-lg px-3 py-2">
                                        <option value="active">active</option>
                                        <option value="suspended">suspended</option>
                                        <option value="ended">ended</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">æ¥­ç¨®å</label>
                                        <input id="business-name" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="è£½é€ æ¥­">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">æ¥­ç¨®ã‚³ãƒ¼ãƒ‰</label>
                                        <input id="business-code" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="E1234">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">æ¥­ç•Œ</label>
                                        <input id="industry" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="é›»æ©Ÿ">
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">å¾“æ¥­å“¡</label>
                                        <input id="total-employees" type="number" min="0" class="w-full border rounded-lg px-3 py-2" placeholder="100">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">å¤–å›½äºº</label>
                                        <input id="foreign-employees" type="number" min="0" class="w-full border rounded-lg px-3 py-2" placeholder="10">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-slate-600 mb-1">å®Ÿç¿’ç”Ÿ</label>
                                        <input id="trainee-count" type="number" min="0" class="w-full border rounded-lg px-3 py-2" placeholder="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-2">
                        <button type="button" id="delete-btn" class="hidden text-red-600 hover:text-red-700" onclick="deleteCompany()">ğŸ—‘ï¸ å‰Šé™¤/ç„¡åŠ¹åŒ–</button>
                        <div class="flex gap-3 ml-auto">
                            <button type="button" class="px-4 py-2 border rounded-lg" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </main>

    <script>
        let companies = [];
        let activeOnly = true;

        const REQUIRED_FIELDS = [
            { key: 'corporation_number', label: 'æ³•äººç•ªå·' },
            { key: 'employment_insurance_number', label: 'é›‡ç”¨ä¿é™ºç•ªå·' },
            { key: 'telephone', label: 'é›»è©±ç•ªå·' },
            { key: 'contact_person', label: 'æ‹…å½“è€…' },
            { key: 'contact_email', label: 'ãƒ¡ãƒ¼ãƒ«' },
            { key: 'postal_code', label: 'éƒµä¾¿ç•ªå·' },
            { key: 'prefecture', label: 'éƒ½é“åºœçœŒ' },
            { key: 'city', label: 'å¸‚åŒºç”ºæ‘' },
            { key: 'contract_start_date', label: 'å¥‘ç´„é–‹å§‹' },
            { key: 'business_type_name', label: 'æ¥­ç¨®å' }
        ];

        function missingFields(company) {
            return REQUIRED_FIELDS.filter(f => !company[f.key]);
        }

        function toggleActiveFilter() {
            activeOnly = !activeOnly;
            document.getElementById('active-toggle').textContent = activeOnly ? 'æœ‰åŠ¹ã®ã¿' : 'ã™ã¹ã¦è¡¨ç¤º';
            renderTable();
        }

        async function loadCompanies() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            try {
                const res = await fetch(`/api/haken-saki?active_only=${activeOnly}`);
                if (!res.ok) throw new Error('API error');
                companies = await res.json();
            } catch (e) {
                companies = [];
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-500">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</td></tr>';
                return;
            }
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            const search = document.getElementById('search').value.toLowerCase();
            const filterMissing = document.getElementById('filter-missing').value;

            let filtered = companies.filter(c => {
                const haystack = `${c.company_name || ''} ${c.branch_name || ''} ${c.full_address || ''} ${c.contact_person || ''}`.toLowerCase();
                return haystack.includes(search);
            });

            filtered = filtered.filter(c => activeOnly ? c.is_active !== false : true);

            if (filterMissing === 'missing') {
                filtered = filtered.filter(c => missingFields(c).length > 0);
            } else if (filterMissing === 'complete') {
                filtered = filtered.filter(c => missingFields(c).length === 0);
            }

            const missingCount = filtered.filter(c => missingFields(c).length > 0).length;
            document.getElementById('stat-total').textContent = filtered.length;
            document.getElementById('stat-missing').textContent = missingCount;
            document.getElementById('stat-complete').textContent = filtered.length - missingCount;

            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-slate-500">è©²å½“ã™ã‚‹æ´¾é£å…ˆãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(company => {
                const missing = missingFields(company);
                const missingTag = missing.length
                    ? `<span class="bg-amber-100 text-amber-700 text-xs px-2 py-1 rounded-full">æƒ…å ±ä¸è¶³ (${missing.length})</span>`
                    : `<span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded-full">å®Œå‚™</span>`;

                const statusTag = company.is_active === false
                    ? '<span class="bg-slate-200 text-slate-700 text-xs px-2 py-1 rounded-full">inactive</span>'
                    : `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full">${company.contract_status || 'active'}</span>`;

                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3">
                            <div class="font-semibold text-slate-800">${company.company_name || '---'}</div>
                            <div class="text-sm text-slate-500">${company.branch_name || ''}</div>
                            <div class="mt-1 flex gap-2 items-center">${missingTag}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-slate-700">
                            <div>${company.telephone || 'â€”'}</div>
                            <div class="text-slate-500">${company.contact_person || ''}</div>
                            <div class="text-slate-400">${company.contact_email || ''}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-slate-700">
                            <div>${company.full_address || [company.prefecture, company.city, company.address_line1].filter(Boolean).join(' ') || 'â€”'}</div>
                            <div class="text-slate-500">ã€’ ${company.postal_code || 'â€”'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-slate-700">
                            <div>${company.contract_start_date || 'â€”'} ~ ${company.contract_end_date || ''}</div>
                            <div class="text-slate-500">${company.business_type_name || company.industry_sector || ''}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-slate-700">${statusTag}</td>
                        <td class="px-4 py-3 text-center">
                            <button class="text-blue-600 hover:text-blue-800 text-sm" onclick='openModal(${JSON.stringify(company)})'>ç·¨é›†</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openModal(data = null) {
            document.getElementById('company-modal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('company-form').reset();
            document.getElementById('delete-btn').classList.add('hidden');

            if (data) {
                document.getElementById('modal-title').textContent = 'æ´¾é£å…ˆç·¨é›†';
                document.getElementById('company-id').value = data.id;
                document.getElementById('company-name').value = data.company_name || '';
                document.getElementById('branch-name').value = data.branch_name || '';
                document.getElementById('corporation-number').value = data.corporation_number || '';
                document.getElementById('insurance-number').value = data.employment_insurance_number || '';
                document.getElementById('telephone').value = data.telephone || '';
                document.getElementById('fax').value = data.fax || '';
                document.getElementById('contact-person').value = data.contact_person || '';
                document.getElementById('contact-email').value = data.contact_email || '';
                document.getElementById('notes').value = data.notes || '';
                document.getElementById('postal-code').value = data.postal_code || '';
                document.getElementById('prefecture').value = data.prefecture || '';
                document.getElementById('city').value = data.city || '';
                document.getElementById('address1').value = data.address_line1 || '';
                document.getElementById('address2').value = data.address_line2 || '';
                document.getElementById('contract-start').value = data.contract_start_date || '';
                document.getElementById('contract-end').value = data.contract_end_date || '';
                document.getElementById('contract-status').value = data.contract_status || 'active';
                document.getElementById('business-name').value = data.business_type_name || '';
                document.getElementById('business-code').value = data.business_type_code || '';
                document.getElementById('industry').value = data.industry_sector || '';
                document.getElementById('total-employees').value = data.total_employees ?? '';
                document.getElementById('foreign-employees').value = data.foreign_employees ?? '';
                document.getElementById('trainee-count').value = data.trainee_count ?? '';
                document.getElementById('delete-btn').classList.remove('hidden');
                document.getElementById('delete-btn').textContent = data.is_active === false ? 'ğŸ—‘ï¸ å®Œå…¨å‰Šé™¤' : 'ğŸ—‘ï¸ å‰Šé™¤/ç„¡åŠ¹åŒ–';
            } else {
                document.getElementById('modal-title').textContent = 'æ´¾é£å…ˆç™»éŒ²';
            }
        }

        function closeModal() {
            document.getElementById('company-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        async function saveCompany() {
            const id = document.getElementById('company-id').value;
            const payload = {
                company_name: document.getElementById('company-name').value,
                branch_name: document.getElementById('branch-name').value || null,
                corporation_number: document.getElementById('corporation-number').value || null,
                employment_insurance_number: document.getElementById('insurance-number').value || null,
                telephone: document.getElementById('telephone').value || null,
                fax: document.getElementById('fax').value || null,
                contact_person: document.getElementById('contact-person').value || null,
                contact_email: document.getElementById('contact-email').value || null,
                notes: document.getElementById('notes').value || null,
                postal_code: document.getElementById('postal-code').value || null,
                prefecture: document.getElementById('prefecture').value || null,
                city: document.getElementById('city').value || null,
                address_line1: document.getElementById('address1').value || null,
                address_line2: document.getElementById('address2').value || null,
                contract_start_date: document.getElementById('contract-start').value || null,
                contract_end_date: document.getElementById('contract-end').value || null,
                contract_status: document.getElementById('contract-status').value || null,
                business_type_name: document.getElementById('business-name').value || null,
                business_type_code: document.getElementById('business-code').value || null,
                industry_sector: document.getElementById('industry').value || null,
                total_employees: document.getElementById('total-employees').value ? Number(document.getElementById('total-employees').value) : null,
                foreign_employees: document.getElementById('foreign-employees').value ? Number(document.getElementById('foreign-employees').value) : null,
                trainee_count: document.getElementById('trainee-count').value ? Number(document.getElementById('trainee-count').value) : null,
            };

            try {
                const res = await fetch(id ? `/api/haken-saki/${id}` : '/api/haken-saki', {
                    method: id ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const error = await res.json().catch(() => ({}));
                    throw new Error(error.detail || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                closeModal();
                await loadCompanies();
            } catch (e) {
                alert(e.message);
            }
        }

        async function deleteCompany() {
            const id = document.getElementById('company-id').value;
            if (!id) return;

            const hard = companies.find(c => c.id == id)?.is_active === false;
            const confirmText = hard ? 'å®Œå…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' : 'ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ';
            if (!confirm(confirmText)) return;

            try {
                const res = await fetch(`/api/haken-saki/${id}?hard_delete=${hard}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                closeModal();
                await loadCompanies();
            } catch (e) {
                alert(e.message);
            }
        }

        function logImport(message, tone = 'info') {
            const el = document.getElementById('json-import-log');
            if (!el) return;
            const color = tone === 'error' ? 'text-red-600' : tone === 'warn' ? 'text-amber-600' : 'text-slate-700';
            const stamp = new Date().toLocaleTimeString();
            el.innerHTML = `<div class="${color}">${stamp} - ${message}</div>` + el.innerHTML;
        }

        function normalizeFactories(data) {
            if (!data) return [];
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.factories)) return data.factories;
            if (Array.isArray(data.items)) return data.items;
            if (data.company_name || data.name || data.factory_name) return [data];
            return [];
        }

        function mapFactory(raw) {
            const pick = (...keys) => keys.map(k => raw && raw[k]).find(Boolean) || null;
            const nested = {
                client: raw?.client_company || {},
                plant: raw?.plant || {},
                contact: raw?.client_company?.responsible_person || raw?.plant?.responsible_person || {},
                contact2: raw?.client_company?.complaint_handler || {}
            };

            const company_name = pick('company_name', 'name', 'factory_name') || nested.client.name || nested.plant.name || 'N/A';
            const corporation_number = pick('corporation_number');
            const employment_insurance_number = pick('employment_insurance_number');
            const telephone = pick('telephone', 'phone', 'tel') || nested.client.phone || nested.plant.phone || nested.contact.phone || nested.contact2.phone;
            const contact_person = pick('contact_person', 'contact') || nested.contact.name || nested.contact2.name;
            const contact_email = pick('contact_email', 'email', 'mail');
            const postal_code = pick('postal_code');
            const prefecture = pick('prefecture');
            const city = pick('city');
            const address_line1 = pick('address_line1', 'address1') || nested.client.address || nested.plant.address;
            const address_line2 = pick('address_line2', 'address2');
            const full_address = pick('full_address', 'address') || nested.client.address || nested.plant.address;
            const business_type_name = pick('business_type_name', 'business');
            const business_type_code = pick('business_type_code');
            const industry_sector = pick('industry_sector');

            return {
                company_name,
                branch_name: pick('branch_name'),
                corporation_number,
                employment_insurance_number,
                telephone,
                fax: pick('fax'),
                contact_person,
                contact_email,
                postal_code,
                prefecture,
                city,
                address_line1,
                address_line2,
                full_address: full_address || [prefecture, city, address_line1].filter(Boolean).join(' ') || null,
                business_type_name,
                business_type_code,
                industry_sector,
                contract_status: pick('contract_status') || 'active'
            };
        }


        function isDuplicate(payload) {
            return companies.some(c =>
                (payload.corporation_number && c.corporation_number === payload.corporation_number) ||
                (payload.company_name && c.company_name === payload.company_name && (!payload.prefecture || payload.prefecture === c.prefecture))
            );
        }

        async function importFactoriesFromJson(content, sourceName) {
            let parsed;
            try {
                parsed = JSON.parse(content);
            } catch (err) {
                throw new Error('JSON invalido: ' + err.message);
            }

            const list = normalizeFactories(parsed);
            if (!list.length) {
                throw new Error('No se encontraron elementos utilizables');
            }

            let ok = 0, skipped = 0, failed = 0;
            for (const raw of list) {
                const payload = mapFactory(raw);
                if (!payload.company_name) { skipped++; continue; }
                if (isDuplicate(payload)) { skipped++; continue; }
                try {
                    const res = await fetch('/api/haken-saki', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error(await res.text());
                    ok++;
                } catch (err) {
                    failed++;
                }
            }
            logImport(`OK ${sourceName}: ${ok} creados, ${skipped} omitidos, ${failed} con error`, failed ? 'warn' : 'info');
            return true;
        }

        async function decodeAndImport(buffer, fileName) {
            const encodings = ['utf-8', 'shift_jis'];
            let lastErr = null;
            for (const enc of encodings) {
                try {
                    const text = new TextDecoder(enc, { fatal: false }).decode(buffer);
                    await importFactoriesFromJson(text, `${fileName} [${enc}]`);
                    return true;
                } catch (err) {
                    lastErr = err;
                }
            }
            logImport(`Error ${fileName}: ${lastErr?.message || 'No se pudo leer el JSON (UTF-8/SJIS)'}`, 'error');
            return false;
        }

        function handleJsonFiles(fileList) {
            const files = Array.from(fileList || []).filter(f => f.name.toLowerCase().endsWith('.json'));
            if (!files.length) {
                logImport('No se encontraron archivos JSON', 'warn');
                return;
            }
            let remaining = files.length;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await decodeAndImport(new Uint8Array(e.target.result), file.name);
                    remaining -= 1;
                    if (remaining === 0) loadCompanies();
                };
                reader.onerror = () => {
                    const err = reader.error;
                    const detail = err?.message || err?.name || 'lectura fallida';
                    logImport(`Error ${file.name}: ${detail}`, 'error');
                    remaining -= 1;
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function initJsonImport() {
            const drop = document.getElementById('json-dropzone');
            const input = document.getElementById('json-file-input');
            const btn = document.getElementById('json-file-btn');
            if (!drop || !input || !btn) return;

            ['dragenter', 'dragover'].forEach(evt => drop.addEventListener(evt, e => {
                e.preventDefault();
                drop.classList.add('border-orange-400', 'bg-orange-50');
            }));
            ['dragleave', 'drop'].forEach(evt => drop.addEventListener(evt, e => {
                e.preventDefault();
                drop.classList.remove('border-orange-400', 'bg-orange-50');
            }));
            drop.addEventListener('drop', e => handleJsonFiles(e.dataTransfer.files));
            btn.addEventListener('click', e => { e.preventDefault(); input.click(); });
            input.addEventListener('change', e => handleJsonFiles(e.target.files));

            logImport('Arrastra factories_index.json y factories/*.json aquÃ­ para cargarlos', 'info');
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderAppShell({ active: 'companies', headline: 'æ´¾é£å…ˆç®¡ç†', subtitle: 'æ´¾é£å…ˆã®æƒ…å ±ã‚’é«˜é€Ÿæ›´æ–°' });
            initJsonImport();
            loadCompanies();
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
            renderFooter();
        });
    </script>
</body>
</html>
