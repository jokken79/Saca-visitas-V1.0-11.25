<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨ç•™æœŸé–“æ›´æ–°è¨±å¯ç”³è«‹æ›¸ - UNS Visa Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen">
    <div class="max-w-6xl mx-auto px-6 py-12">
        <!-- Header -->
        <header class="text-center mb-12">
            <div class="inline-flex items-center gap-4 mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-green-500/30">
                    <span class="text-3xl">ğŸ”„</span>
                </div>
            </div>
            <h1 class="text-4xl font-bold text-white mb-4">åœ¨ç•™æœŸé–“æ›´æ–°è¨±å¯ç”³è«‹æ›¸</h1>
            <p class="text-xl text-green-200">Application for Extension of Period of Stay</p>
            <div class="mt-6">
                <a href="index.html" class="text-blue-300 hover:text-blue-200 transition-colors">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
            </div>
        </header>

        <!-- Employee Selection -->
        <div class="bg-white/10 backdrop-blur rounded-2xl p-6 mb-8">
            <h2 class="text-xl font-bold text-white mb-4">å¾“æ¥­å“¡é¸æŠ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">å¾“æ¥­å“¡ã‚’é¸æŠ</label>
                    <select id="employee-select" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">-- å¾“æ¥­å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="clearForm()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                        ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form id="renewal-form" class="space-y-8">
            <!-- Personal Information Section -->
            <div class="bg-white/10 backdrop-blur rounded-2xl p-6">
                <h2 class="text-2xl font-bold text-white mb-6 border-b border-slate-600 pb-3">ç”³è«‹äººæƒ…å ±</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- æ°å (Name) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-300 mb-2">æ°å (Name) <span class="text-red-400">*</span></label>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="family-name" name="family_name" placeholder="å§“ (Family Name)" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            <input type="text" id="given-name" name="given_name" placeholder="å (Given Name)" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                    </div>

                    <!-- å›½ç±ãƒ»åœ°åŸŸ (Nationality) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">å›½ç±ãƒ»åœ°åŸŸ (Nationality) <span class="text-red-400">*</span></label>
                        <input type="text" id="nationality" name="nationality" placeholder="ä¾‹: ä¸­å›½" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- ç”Ÿå¹´æœˆæ—¥ (Date of Birth) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">ç”Ÿå¹´æœˆæ—¥ (Date of Birth) <span class="text-red-400">*</span></label>
                        <input type="date" id="date-of-birth" name="date_of_birth" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- æ€§åˆ¥ (Gender) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">æ€§åˆ¥ (Gender) <span class="text-red-400">*</span></label>
                        <select id="gender" name="gender" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="male">ç”·æ€§ (Male)</option>
                            <option value="female">å¥³æ€§ (Female)</option>
                        </select>
                    </div>

                    <!-- é…å¶è€…ã®æœ‰ç„¡ (Marital Status) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">é…å¶è€…ã®æœ‰ç„¡ (Marital Status) <span class="text-red-400">*</span></label>
                        <select id="marital-status" name="marital_status" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="married">æœ‰ (Married)</option>
                            <option value="single">ç„¡ (Single)</option>
                        </select>
                    </div>

                    <!-- è·æ¥­ (Occupation) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">è·æ¥­ (Occupation) <span class="text-red-400">*</span></label>
                        <input type="text" id="occupation" name="occupation" placeholder="ä¾‹: ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- ä½å±…åœ° (Address) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-300 mb-2">ä½å±…åœ° (Address) <span class="text-red-400">*</span></label>
                        <input type="text" id="address" name="address" placeholder="ä¾‹: æ±äº¬éƒ½æ–°å®¿åŒº..." class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                </div>
            </div>

            <!-- Passport & Visa Information Section -->
            <div class="bg-white/10 backdrop-blur rounded-2xl p-6">
                <h2 class="text-2xl font-bold text-white mb-6 border-b border-slate-600 pb-3">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆãƒ»åœ¨ç•™è³‡æ ¼æƒ…å ±</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå· (Passport Number) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå· (Passport Number) <span class="text-red-400">*</span></label>
                        <input type="text" id="passport-number" name="passport_number" placeholder="ä¾‹: E12345678" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå· (Residence Card Number) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">åœ¨ç•™ã‚«ãƒ¼ãƒ‰ç•ªå· (Residence Card Number) <span class="text-red-400">*</span></label>
                        <input type="text" id="zairyu-card-number" name="zairyu_card_number" placeholder="ä¾‹: AB1234567890" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- ç¾åœ¨ã®åœ¨ç•™è³‡æ ¼ (Current Visa Status) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">ç¾åœ¨ã®åœ¨ç•™è³‡æ ¼ (Current Visa Status) <span class="text-red-400">*</span></label>
                        <select id="current-visa-status" name="current_visa_status" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æŠ€è¡“ãƒ»äººæ–‡çŸ¥è­˜ãƒ»å›½éš›æ¥­å‹™">æŠ€è¡“ãƒ»äººæ–‡çŸ¥è­˜ãƒ»å›½éš›æ¥­å‹™</option>
                            <option value="æŠ€èƒ½">æŠ€èƒ½</option>
                            <option value="ç‰¹å®šæŠ€èƒ½">ç‰¹å®šæŠ€èƒ½</option>
                            <option value="ç•™å­¦">ç•™å­¦</option>
                        </select>
                    </div>

                    <!-- åœ¨ç•™æœŸé–“ (Period of Stay) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">åœ¨ç•™æœŸé–“ (Period of Stay) <span class="text-red-400">*</span></label>
                        <select id="period-of-stay" name="period_of_stay" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="3ãƒ¶æœˆ">3ãƒ¶æœˆ</option>
                            <option value="6ãƒ¶æœˆ">6ãƒ¶æœˆ</option>
                            <option value="1å¹´">1å¹´</option>
                            <option value="3å¹´">3å¹´</option>
                            <option value="5å¹´">5å¹´</option>
                        </select>
                    </div>

                    <!-- åœ¨ç•™æœŸé™ (Expiration Date) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">åœ¨ç•™æœŸé™ (Expiration Date) <span class="text-red-400">*</span></label>
                        <input type="date" id="expiration-date" name="expiration_date" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- å¸Œæœ›ã™ã‚‹åœ¨ç•™æœŸé–“ (Desired Period) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">å¸Œæœ›ã™ã‚‹åœ¨ç•™æœŸé–“ (Desired Period) <span class="text-red-400">*</span></label>
                        <select id="desired-period" name="desired_period" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="6ãƒ¶æœˆ">6ãƒ¶æœˆ</option>
                            <option value="1å¹´">1å¹´</option>
                            <option value="3å¹´">3å¹´</option>
                            <option value="5å¹´">5å¹´</option>
                        </select>
                    </div>

                    <!-- æ›´æ–°ã®ç†ç”± (Reason for Renewal) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-300 mb-2">æ›´æ–°ã®ç†ç”± (Reason for Renewal) <span class="text-red-400">*</span></label>
                        <textarea id="renewal-reason" name="renewal_reason" rows="4" placeholder="ä¾‹: å¼•ãç¶šãã€æ´¾é£å…ˆä¼æ¥­ã§ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ¥­å‹™ã«å¾“äº‹ã™ã‚‹ãŸã‚" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Workplace Information Section -->
            <div class="bg-white/10 backdrop-blur rounded-2xl p-6">
                <h2 class="text-2xl font-bold text-white mb-6 border-b border-slate-600 pb-3">æ´¾é£å…ˆæƒ…å ±</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- æ´¾é£å…ˆä¼šç¤¾å (Company Name) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-300 mb-2">æ´¾é£å…ˆä¼šç¤¾å (Company Name) <span class="text-red-400">*</span></label>
                        <input type="text" id="workplace-company" name="workplace_company" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾â—‹â—‹" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- æ´¾é£å…ˆä½æ‰€ (Company Address) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-300 mb-2">æ´¾é£å…ˆä½æ‰€ (Company Address) <span class="text-red-400">*</span></label>
                        <input type="text" id="workplace-address" name="workplace_address" placeholder="ä¾‹: æ±äº¬éƒ½åƒä»£ç”°åŒº..." class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- æ´¾é£å…ˆé›»è©±ç•ªå· (Company Phone) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">æ´¾é£å…ˆé›»è©±ç•ªå· (Company Phone)</label>
                        <input type="tel" id="workplace-phone" name="workplace_phone" placeholder="ä¾‹: 03-1234-5678" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <!-- æ¥­å‹™å†…å®¹ (Job Description) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">æ¥­å‹™å†…å®¹ (Job Description) <span class="text-red-400">*</span></label>
                        <input type="text" id="job-description" name="job_description" placeholder="ä¾‹: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>

                    <!-- æœˆçµ¦ (Monthly Salary) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">æœˆçµ¦ (Monthly Salary)</label>
                        <input type="number" id="monthly-salary" name="monthly_salary" placeholder="ä¾‹: 250000" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <!-- æ´¾é£é–‹å§‹æ—¥ (Assignment Start Date) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">æ´¾é£é–‹å§‹æ—¥ (Assignment Start Date)</label>
                        <input type="date" id="assignment-start" name="assignment_start" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="bg-white/10 backdrop-blur rounded-2xl p-6">
                <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                    <button type="submit" class="px-8 py-4 bg-gradient-to-br from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white font-bold text-lg rounded-xl shadow-xl hover:shadow-2xl hover:shadow-green-500/30 transition-all">
                        ğŸ“„ ç”³è«‹æ›¸ã‚’ç”Ÿæˆ (Generate Application)
                    </button>
                    <div id="status-message" class="text-sm"></div>
                </div>
            </div>
        </form>

        <!-- Footer -->
        <footer class="text-center text-slate-500 text-sm mt-12">
            <p>UNS Visa Management System v1.0</p>
            <p class="mt-1">Â© 2024 UNSæ ªå¼ä¼šç¤¾</p>
        </footer>
    </div>

    <script>
        // Load employees on page load
        async function loadEmployees() {
            try {
                const response = await fetch('/api/employees');
                if (response.ok) {
                    const employees = await response.json();
                    const select = document.getElementById('employee-select');

                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.family_name} ${emp.given_name} (${emp.nationality})`;
                        option.dataset.employee = JSON.stringify(emp);
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Failed to load employees:', e);
                showStatus('å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // Auto-fill form when employee is selected
        document.getElementById('employee-select').addEventListener('change', function(e) {
            if (!e.target.value) {
                clearForm();
                return;
            }

            const employeeData = JSON.parse(e.target.options[e.target.selectedIndex].dataset.employee);

            // Fill personal information
            document.getElementById('family-name').value = employeeData.family_name || '';
            document.getElementById('given-name').value = employeeData.given_name || '';
            document.getElementById('nationality').value = employeeData.nationality || '';
            document.getElementById('date-of-birth').value = employeeData.date_of_birth || '';
            document.getElementById('gender').value = employeeData.gender || '';
            document.getElementById('marital-status').value = employeeData.marital_status || '';
            document.getElementById('occupation').value = employeeData.occupation || '';
            document.getElementById('address').value = employeeData.address_in_japan || '';

            // Fill passport & visa information
            document.getElementById('passport-number').value = employeeData.passport_number || '';
            document.getElementById('zairyu-card-number').value = employeeData.zairyu_card_number || '';
            document.getElementById('current-visa-status').value = employeeData.visa_type || '';
            document.getElementById('period-of-stay').value = employeeData.visa_duration || '';
            document.getElementById('expiration-date').value = employeeData.visa_expiry_date || '';

            // Fill workplace information if available
            if (employeeData.current_haken_saki) {
                document.getElementById('workplace-company').value = employeeData.current_haken_saki.company_name || '';
                document.getElementById('workplace-address').value = employeeData.current_haken_saki.address || '';
                document.getElementById('workplace-phone').value = employeeData.current_haken_saki.phone || '';
                document.getElementById('job-description').value = employeeData.current_haken_saki.job_description || '';
                document.getElementById('monthly-salary').value = employeeData.current_haken_saki.monthly_salary || '';
                document.getElementById('assignment-start').value = employeeData.current_haken_saki.assignment_start_date || '';
            }
        });

        // Clear form
        function clearForm() {
            document.getElementById('renewal-form').reset();
            document.getElementById('employee-select').value = '';
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;

            if (type === 'error') {
                statusDiv.className = 'text-sm text-red-400 font-medium';
            } else if (type === 'success') {
                statusDiv.className = 'text-sm text-green-400 font-medium';
            } else {
                statusDiv.className = 'text-sm text-blue-400 font-medium';
            }

            // Clear message after 5 seconds
            setTimeout(() => {
                statusDiv.textContent = '';
            }, 5000);
        }

        // Form submission
        document.getElementById('renewal-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            showStatus('ç”³è«‹æ›¸ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...', 'info');

            // Collect form data
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/excel/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        form_type: 'renewal',
                        data: data
                    })
                });

                if (response.ok) {
                    // Get the blob from response
                    const blob = await response.blob();

                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    // Generate filename with current date and employee name
                    const familyName = document.getElementById('family-name').value;
                    const givenName = document.getElementById('given-name').value;
                    const today = new Date().toISOString().split('T')[0];
                    a.download = `åœ¨ç•™æœŸé–“æ›´æ–°è¨±å¯ç”³è«‹æ›¸_${familyName}${givenName}_${today}.xlsx`;

                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showStatus('ç”³è«‹æ›¸ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼', 'success');
                } else {
                    const error = await response.json();
                    showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.detail || 'ç”³è«‹æ›¸ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('ç”³è«‹æ›¸ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        });

        // Load employees on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadEmployees();
        });
    </script>
</body>
</html>
